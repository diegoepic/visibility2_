<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DIAGEO Quiz – Stand</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<style>
  :root{
    --gold:#c8a64a; --gold-2:#f6e7b8; --black:#0d0d0d; --ink:#111;
    --green:#138a59; --green-d:#0f6a45; --jw:#6b5a25; --jw-d:#54461e;
    --ok:#45d07b; --err:#ff5a6b; --txt:#f3f3f3; --muted:#b7b7b7;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--txt);}
  button{cursor:pointer;border:0;font-weight:700;border-radius:16px}
  .screen{display:none;position:fixed;inset:0;padding: clamp(12px,2vw,24px);}
  .show{display:flex;align-items:center;justify-content:center}
  .full-bg{position:absolute;inset:0;background:center/cover no-repeat;z-index:-2}
  .veil{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.55));z-index:-1}
  .cta{background:linear-gradient(var(--gold-2),var(--gold));color:#171309;font-size:clamp(20px,3.4vw,36px);padding:18px 28px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .footer{position:fixed;left:16px;right:16px;bottom:12px;display:flex;justify-content:space-between;align-items:center;color:#ddd;font-size:clamp(12px,1.5vw,14px)}
  .gold{color:var(--gold)}
  .hidden{display:none !important}
  .card{width:min(100%, 820px);padding: clamp(16px,2.5vw,28px);border-radius:28px;
        background: rgba(18,18,18,.66);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08);
        box-shadow: 0 10px 30px rgba(0,0,0,.4);}
  .title{margin:0 0 10px 0;font-size: clamp(22px,2.8vw,34px);letter-spacing:.5px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .row>*{flex:1}
  input{width:100%;padding:18px 18px;border-radius:16px;border:1px solid #2c2c2c;background:#0e0e0e;color:#eee;
        font-size:clamp(18px,2vw,20px);outline:none}
  input:focus{border-color:#3e3e3e; box-shadow:0 0 0 4px rgba(255,255,255,.05)}
  label{color:#ddd;font-size:clamp(12px,1.6vw,14px);margin:6px 0 6px;display:block;letter-spacing:.3px}
  .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
  .btn{padding:16px 20px;background:#1a1a1a;color:#fff;border:1px solid #343434;font-size:clamp(16px,2vw,18px)}
  .btn.secondary{background:transparent}

  /* PREGUNTAS */
  .qwrap{width:min(100%,1100px);display:grid;gap:clamp(14px,2vw,18px)}
  .brand-head{display:flex;justify-content:space-between;align-items:flex-end}
  .brand-name{font-size: clamp(20px,3vw,30px);margin:0}
  .question{font-size: clamp(20px,3vw,30px);margin:4px 0 8px 0;line-height:1.2}
  .options{display:grid;gap: clamp(12px,1.8vw,16px);grid-template-columns: 1fr; margin-top:4px}
  .opt{
    display:flex; gap:16px; align-items:center; text-align:left; padding: clamp(16px,2vw,22px);
    font-size: clamp(18px,2.4vw,24px); color:#fff; border-radius:20px; position:relative; overflow:hidden;
    border:1px solid rgba(255,255,255,.08); box-shadow: 0 8px 18px rgba(0,0,0,.35);
    transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
  }
  .opt:active{transform: scale(.98)}
  .opt.tq{background: linear-gradient(180deg,var(--green),var(--green-d))}
  .opt.jw{background: linear-gradient(180deg,var(--jw),var(--jw-d))}
  .letter{width:44px;height:44px;min-width:44px;border-radius:50%;background:rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;font-weight:800}
  .timer{height:12px;border-radius:10px;background:#2a2a2a;overflow:hidden}
  .timer>div{height:100%;background:linear-gradient(90deg,#53e39b,#47d391);width:100%}

  /* Feedback visual */
  .pulse-ok{animation: pulseOk .9s ease}
  @keyframes pulseOk{0%{box-shadow:0 0 0 0 rgba(69,208,123,.7)}100%{box-shadow:0 0 0 24px rgba(69,208,123,0)}}
  .shake{animation:shake .35s linear}
  @keyframes shake{10%,90%{transform:translateX(-2px)} 20%,80%{transform:translateX(4px)} 30%,50%,70%{transform:translateX(-6px)} 40%,60%{transform:translateX(6px)}}

  /* Toast */
  #toast{position:fixed;left:50%;bottom:6vh;transform:translateX(-50%);background:#111;color:#fff;border:1px solid #333;
         padding:14px 18px;border-radius:999px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.45);font-size:clamp(14px,2vw,18px)}
  #toast.ok{border-color:#39d48b}
  #toast.err{border-color:#ff6e7b}

  /* Overlay feedback (Correcto/Incorrecto) */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter: blur(3px)}
  .overlay.show{display:flex}
  .ov-card{padding:24px 28px;border-radius:24px;background:#0f0f0f;border:1px solid #333;text-align:center;box-shadow:0 14px 42px rgba(0,0,0,.5)}
  .ov-title{margin:0;color:#fff;font-size:clamp(22px,3.2vw,36px)}
  .ov-sub{margin:6px 0 0;color:#bbb}
  .ov-ok{border-color:#34d089}
  .ov-err{border-color:#ff6e7b}

  /* Badges final */
  .badges{position:absolute;top:16px;left:16px;display:flex;gap:10px}
  .badge{padding:10px 14px;border-radius:999px;border:1px solid #444;background:#0f0f0f;color:#eee}

  /* Admin */
  #staffPanel{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center}
  #staffPanel .card{width:min(100%, 880px)}
</style>
</head>
<body>

<!-- Portada -->
<section id="scrHome" class="screen show" aria-label="Portada">
  <div class="full-bg" style="background-image:url('assets/1.png')"></div>
  <div class="veil"></div>
  <button id="btnStart" class="cta" aria-label="Comenzar a jugar">JUGAR</button>
  <div class="footer">
    <span>Holiday Meeting · DIAGEO</span>
    <span id="staffTap" class="gold" role="button" aria-label="Abrir panel administrador">Panel admin</span>
  </div>
</section>

<!-- Formulario -->
<section id="scrForm" class="screen" aria-label="Formulario">
  <div class="full-bg" style="background:#000"></div>
  <div class="card" role="form" aria-describedby="formHelp">
    <h2 class="title gold" style="margin-top:0">DATOS DEL PARTICIPANTE</h2>
    <p id="formHelp" style="margin:0 0 12px 0;color:#ccc;font-size:clamp(12px,1.6vw,14px)">Tus datos se usan solo para el sorteo. +18.</p>
    <div class="row">
      <div><label for="fName">NOMBRE COMPLETO</label><input id="fName" required autocomplete="name" placeholder="Escribe tu nombre"></div>
    </div>
    <div class="row">
      <div><label for="fEmail">CORREO (opcional)</label><input id="fEmail" type="email" autocomplete="email" placeholder="nombre@correo.com"></div>
      <div><label for="fPhone">TELÉFONO (opcional)</label><input id="fPhone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+56 9 1234 5678"></div>
    </div>
    <div class="row">
      <div><label for="fAge">EDAD</label><input id="fAge" type="number" min="18" step="1" value="18"></div>
    </div>
    <label style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <input id="f18" type="checkbox"> <span>Declaro ser mayor de 18 años</span>
    </label>
    <div class="btns">
      <button id="btnFormNext" class="cta">Comenzar</button>
      <button id="btnFormBack" class="btn secondary">Volver</button>
    </div>
  </div>
</section>

<!-- Pregunta Tanqueray -->
<section id="scrTQ" class="screen" aria-label="Pregunta Tanqueray">
  <div class="full-bg" style="background-image:url('assets/3.png')"></div>
  <div class="veil"></div>
  <div class="qwrap">
    <div class="brand-head">
      <h3 class="brand-name">Tanqueray</h3>
      <div class="pill gold">Pregunta 1 de 2</div>
    </div>
    <h4 id="tqQ" class="question">¿Cómo se prepara un Gin Tanqueray & Tonic perfecto?</h4>
    <div id="tqOpts" class="options" role="listbox" aria-label="Opciones Tanqueray"></div>
    <div class="timer" aria-hidden="true"><div id="tqTimer"></div></div>
  </div>
</section>

<!-- Pregunta Johnnie Walker -->
<section id="scrJW" class="screen" aria-label="Pregunta Johnnie Walker">
  <div class="full-bg" style="background-image:url('assets/4.png')"></div>
  <div class="veil"></div>
  <div class="qwrap">
    <div class="brand-head">
      <h3 class="brand-name">Johnnie Walker</h3>
      <div class="pill gold">Pregunta 2 de 2</div>
    </div>
    <h4 id="jwQ" class="question">¿Cuál de estos NO es una variante de Johnnie Walker?</h4>
    <div id="jwOpts" class="options" role="listbox" aria-label="Opciones Johnnie Walker"></div>
    <div class="timer" aria-hidden="true"><div id="jwTimer"></div></div>
  </div>
</section>

<!-- Estás participando TQ -->
<section id="scrTQOk" class="screen" aria-label="Participando Tanqueray">
  <div class="full-bg" style="background-image:url('assets/7.png')"></div>
</section>

<!-- Estás participando JW -->
<section id="scrJWOk" class="screen" aria-label="Participando Johnnie Walker">
  <div class="full-bg" style="background-image:url('assets/6.png')"></div>
</section>

<!-- Final / Sigue participando -->
<section id="scrEnd" class="screen" aria-label="Final">
  <div class="full-bg" style="background-image:url('assets/9.png')"></div>
  <div class="badges">
    <span id="badgeTQ" class="badge hidden">Entraste a Tanqueray</span>
    <span id="badgeJW" class="badge hidden">Entraste a Johnnie Walker</span>
  </div>
</section>

<!-- Overlay feedback -->
<div id="overlay" class="overlay" aria-live="polite" aria-atomic="true">
  <div id="ovCard" class="ov-card">
    <h3 id="ovTitle" class="ov-title">Mensaje</h3>
    <p id="ovSub" class="ov-sub"></p>
  </div>
</div>

<!-- Toast -->
<div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- Panel admin -->
<div id="staffPanel">
  <div class="card">
    <h3 style="margin:0 0 12px 0">Panel de Administradores</h3>
    <div class="row" style="gap:10px">
      <button id="btnExportParticipants" class="btn">Exportar participants.csv</button>
      <button id="btnExportRounds" class="btn">Exportar rounds.csv</button>
      <button id="btnExportEntries" class="btn">Exportar entries.csv</button>
      <button id="btnExportEvents" class="btn">Exportar events.jsonl</button>
    </div>
    <hr style="border-color:#333">
    <div class="row" style="gap:10px">
      <button id="btnPickDir" class="btn">Elegir carpeta para respaldo (NDJSON)</button>
      <button id="btnCloseStaff" class="btn secondary">Cerrar</button>
      <button id="btnHardReset" class="btn">Reset a Portada</button>
    </div>
    <small id="dirInfo" style="color:#bbb"></small>
  </div>
</div>

<script>
/* ---------------- PWA ---------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
}

/* -------------- Helpers UI ----------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let idleTimer;
function show(id){ $$('.screen').forEach(s=>s.classList.remove('show')); $('#'+id).classList.add('show'); resetIdle(); }
function resetIdle(){ clearTimeout(idleTimer); idleTimer = setTimeout(()=> hardReset(), 35000); }
['click','pointerdown','keydown'].forEach(ev=>document.addEventListener(ev, resetIdle));
const uid = p => `${p}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;

/* ---- Hora de Chile (America/Santiago) ---- */
const CL_TZ = 'America/Santiago';
function nowChile(date = new Date()){
  const fmt = new Intl.DateTimeFormat('es-CL', {
    timeZone: CL_TZ, year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  });
  const parts = Object.fromEntries(fmt.formatToParts(date).map(p => [p.type, p.value]));
  return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;
}

function toast(msg, type){ const t=$('#toast'); t.textContent=msg; t.className=''; t.classList.add(type||''); t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none', 1800); }
function overlay(type, title, sub){
  const o=$('#overlay'), c=$('#ovCard');
  $('#ovTitle').textContent=title||''; $('#ovSub').textContent=sub||'';
  c.className='ov-card ' + (type==='ok'?'ov-ok':'ov-err'); o.classList.add('show');
  clearTimeout(o._h); o._h=setTimeout(()=>o.classList.remove('show'), 900);
}

/* -------------- Config preguntas ----- */
const QUESTIONS = {
  tanqueray: {
    id:'tq_q01',
    text:'¿Cómo se prepara un Gin Tanqueray & Tonic perfecto?',
    options:[
      '35% gin Tanqueray · 65% agua tónica premium · limón',
      '30% gin Tanqueray · 70% agua tónica premium · limón', // correcta
      '25% gin Tanqueray · 75% agua tónica premium · limón'
    ],
    correctIndex:1,
    screenOk:'scrTQOk',
    timeLimitMs:15000
  },
  johnnie_walker: {
    id:'jw_q01',
    text:'¿Cuál de estos NO es una variante de Johnnie Walker?',
    options:['Johnnie Walker Black','Johnnie Walker Honey','Johnnie Walker Gold','Johnnie Walker Blonde'],
    correctIndex:1,
    screenOk:'scrJWOk',
    timeLimitMs:15000
  }
};

/* -------------- IndexedDB ------------- */
let db;
(function openDB(){
  const req = indexedDB.open('diageo-game', 1);
  req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore('participants', { keyPath:'participant_id' });
    db.createObjectStore('rounds', { keyPath:'round_id' });
    db.createObjectStore('entries', { keyPath:'entry_id' });
    db.createObjectStore('events', { keyPath:'event_id' });
  };
  req.onsuccess = e => { db = e.target.result; };
})();
function put(store,obj){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(obj); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
function all(store){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r=[]; tx.objectStore(store).openCursor().onsuccess=e=>{ const c=e.target.result; if(c){ r.push(c.value); c.continue(); } else res(r); }; tx.onerror=()=>rej(tx.error); }); }

/* -------------- Respaldo (File System API) */
let dirHandle = null;
async function pickDir(){ try{ dirHandle = await window.showDirectoryPicker(); $('#dirInfo').textContent='Carpeta seleccionada para respaldo.'; }catch{} }
async function appendNDJSON(filename,obj){
  if(!dirHandle) return;
  const fileHandle=await dirHandle.getFileHandle(filename,{create:true});
  const writable=await fileHandle.createWritable({keepExistingData:true});
  await writable.write(JSON.stringify(obj)+'\n'); await writable.close();
}

/* -------------- Eventos (log) ---------- */
async function logEvent(type, data={}){
  try{
    const now = new Date();
    const evt={
      event_id: uid('evt'),
      ts: now.toISOString(),   // UTC
      ts_cl: nowChile(now),    // Chile
      tz: CL_TZ,
      type,
      ...data
    };
    await put('events', evt); await appendNDJSON('events.ndjson', evt); return evt;
  }catch(e){ toast('No se pudo guardar el evento', 'err'); console.error(e); }
}

/* -------------- CSV en español ---------- */
const SEP = ';';
function boolES(v){ return v === true ? 'Sí' : v === false ? 'No' : ''; }

// Genera CSV usando mapeo {key, header, transform?}
function toCSVLocalized(rows, columns, sep = SEP){
  const esc = v => `"${String(v ?? '').replaceAll('"','""')}"`;
  const headers = columns.map(c => c.header).join(sep);
  if (!rows || rows.length === 0) return headers + '\r\n';
  const lines = rows.map(row =>
    columns.map(c => {
      let val = row[c.key];
      if (typeof c.transform === 'function') val = c.transform(val, row);
      return esc(val);
    }).join(sep)
  );
  return headers + '\r\n' + lines.join('\r\n');
}
// Descarga con BOM para Excel/Windows
function downloadCSV(name, text){
  const blob = new Blob(["\ufeff" + text], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

// Mapeos de columnas en español (incluye UTC y Chile)
const PARTICIPANT_COLUMNS = [
  { key:'participant_id', header:'ID PARTICIPANTE' },
  { key:'name',          header:'NOMBRE' },
  { key:'email',         header:'CORREO' },
  { key:'phone',         header:'TELÉFONO' },
  { key:'is_18plus',     header:'MAYOR DE 18', transform: boolES },
  { key:'created_at',    header:'FECHA DE REGISTRO (UTC ISO)' },
  { key:'created_at_cl', header:'FECHA DE REGISTRO ' },
  { key:'device_id',     header:'ID DISPOSITIVO' },
];

const ROUNDS_COLUMNS = [
  { key:'round_id',          header:'ID RONDA' },
  { key:'participant_id',    header:'ID PARTICIPANTE' },
  { key:'started_at',        header:'INICIO (UTC ISO)' },
  { key:'started_at_cl',     header:'INICIO' },
  { key:'finished_at',       header:'FIN (UTC ISO)' },
  { key:'finished_at_cl',    header:'FIN ' },
  { key:'tanq_shown',        header:'TANQUERAY MOSTRADA',        transform: boolES },
  { key:'tanq_answered',     header:'TANQUERAY RESPONDIDA',      transform: boolES },
  { key:'tanq_question_id',  header:'TANQUERAY ID PREGUNTA' },
  { key:'tanq_answer',       header:'TANQUERAY RESPUESTA' },
  { key:'tanq_correct',      header:'TANQUERAY CORRECTA',        transform: v => v==null ? '' : boolES(v) },
  { key:'tanq_time_ms',      header:'TANQUERAY TIEMPO (ms)' },
  { key:'jw_shown',          header:'JOHNNIE WALKER MOSTRADA',   transform: boolES },
  { key:'jw_answered',       header:'JOHNNIE WALKER RESPONDIDA', transform: boolES },
  { key:'jw_question_id',    header:'JW ID PREGUNTA' },
  { key:'jw_answer',         header:'JW RESPUESTA' },
  { key:'jw_correct',        header:'JW CORRECTA',               transform: v => v==null ? '' : boolES(v) },
  { key:'jw_time_ms',        header:'JW TIEMPO (ms)' },
  { key:'entered_brands',    header:'MARCAS EN LAS QUE ENTRA',   transform: v => Array.isArray(v) ? v.join(' | ') : '' },
];

const ENTRIES_COLUMNS = [
  { key:'entry_id',      header:'ID INSCRIPCIÓN' },
  { key:'round_id',      header:'ID RONDA' },
  { key:'participant_id',header:'ID PARTICIPANTE' },
  { key:'brand',         header:'MARCA' },
  { key:'qualified',     header:'CLASIFICA',           transform: boolES },
  { key:'reason',        header:'MOTIVO' },
  { key:'answer',        header:'RESPUESTA' },
  { key:'correct',       header:'RESPUESTA CORRECTA',  transform: v => v==null ? '' : boolES(v) },
  { key:'responded_at',    header:'FECHA RESPUESTA (UTC ISO)' },
  { key:'responded_at_cl', header:'FECHA RESPUESTA' },
];

/* -------------- Estado ------------------ */
let device_id = localStorage.getItem('device_id') || (localStorage.setItem('device_id', uid('dev')), localStorage.getItem('device_id'));
let participant=null, round=null;
let entries = { tanqueray:false, johnnie_walker:false };

/* -------------- Flujo ------------------- */
$('#btnStart').onclick = ()=> show('scrForm');
$('#btnFormBack').onclick = ()=> show('scrHome');

$('#btnFormNext').onclick = async ()=>{
  const name = $('#fName').value.trim();
  const age  = parseInt($('#fAge').value||'0',10);
  if(!name || !$('#f18').checked || isNaN(age) || age<18){ toast('Completa nombre y confirma ser +18', 'err'); return; }
  const now = new Date();
  participant = {
    participant_id: uid('p'),
    name,
    email: $('#fEmail').value.trim(),
    phone: $('#fPhone').value.trim(),
    is_18plus: true,
    created_at: now.toISOString(),   // UTC
    created_at_cl: nowChile(now),    // Chile
    device_id
  };
  await put('participants', participant);
  await logEvent('participant_registered', {participant_id: participant.participant_id, name: participant.name});

  const nowStart = new Date();
  round = {
    round_id: uid('r'),
    participant_id: participant.participant_id,
    started_at: nowStart.toISOString(),   // UTC
    started_at_cl: nowChile(nowStart),    // Chile
    finished_at: null,
    finished_at_cl: null,
    tanq_shown:false, tanq_answered:false, tanq_question_id:null, tanq_answer:null, tanq_correct:null, tanq_time_ms:null,
    jw_shown:false,   jw_answered:false,   jw_question_id:null,   jw_answer:null,   jw_correct:null,   jw_time_ms:null,
    entered_brands:[]
  };
  await put('rounds', round);
  await logEvent('round_started', {round_id: round.round_id, participant_id: round.participant_id});

  startQuestion('tanqueray');
};

/* -------------- Timer ------------------- */
function startTimer(ms, el, onTick, onEnd){
  const start=performance.now(); el.style.width='100%'; let af;
  function frame(t){ const dt=t-start; const left=Math.max(0,1-(dt/ms)); el.style.width=(left*100)+'%'; onTick?.(dt); if(dt>=ms){ cancelAnimationFrame(af); onEnd?.(ms); } else { af=requestAnimationFrame(frame); } }
  af=requestAnimationFrame(frame); return ()=>cancelAnimationFrame(af);
}

/* -------------- Render Preguntas -------- */
function renderQuestion(brand){
  const cfg=QUESTIONS[brand];
  const wrap = (brand==='tanqueray') ? $('#tqOpts') : $('#jwOpts');
  wrap.innerHTML='';
  cfg.options.forEach((txt,idx)=>{
    const b=document.createElement('button');
    b.className='opt ' + (brand==='tanqueray' ? 'tq' : 'jw');
    b.innerHTML = `<span class="letter">${String.fromCharCode(65+idx)}</span> <span>${txt}</span>`;
    b.onclick = ()=> submitAnswer(brand, idx, txt, b);
    wrap.appendChild(b);
  });
  (brand==='tanqueray' ? $('#tqQ') : $('#jwQ')).textContent = cfg.text;
}

let cancelTimerFn=null;
async function startQuestion(brand){
  renderQuestion(brand);
  const cfg=QUESTIONS[brand];
  if(brand==='tanqueray'){ show('scrTQ'); round.tanq_shown=true; round.tanq_question_id=cfg.id; }
  else { show('scrJW'); round.jw_shown=true; round.jw_question_id=cfg.id; }
  await put('rounds', round);
  await logEvent('question_shown', {round_id: round.round_id, brand, question_id: cfg.id});
  const bar = (brand==='tanqueray') ? $('#tqTimer') : $('#jwTimer');
  let elapsed=0;
  cancelTimerFn = startTimer(cfg.timeLimitMs, bar, dt=>{ elapsed=dt|0; }, ()=> submitAnswer(brand, null, null, null, elapsed));
}

function disableOptions(containerSel){ $$(containerSel+' .opt').forEach(o=> o.disabled=true); }

async function submitAnswer(brand, idx, txt, btn, elapsedMs){
  if(cancelTimerFn){ cancelTimerFn(); cancelTimerFn=null; }
  const cfg=QUESTIONS[brand];
  const is_correct = (idx===cfg.correctIndex);
  const response_ms = typeof elapsedMs==='number' ? elapsedMs : Math.min(99999, cfg.timeLimitMs);

  // Lock UI
  if(brand==='tanqueray') disableOptions('#tqOpts'); else disableOptions('#jwOpts');

  await logEvent('answer_submitted', {
    round_id: round.round_id, brand, question_id: cfg.id,
    answer_index: idx, answer_text: txt, is_correct, response_ms
  });

  // Persist en round
  if(brand==='tanqueray'){
    round.tanq_answered = idx!==null; round.tanq_answer = txt; round.tanq_correct = idx!==null ? is_correct : null; round.tanq_time_ms = response_ms;
  }else{
    round.jw_answered = idx!==null; round.jw_answer = txt; round.jw_correct = idx!==null ? is_correct : null; round.jw_time_ms = response_ms;
  }
  await put('rounds', round);

  // Feedback + regla: entra SOLO si acierta
  if(idx===null){
    toast('Se acabó el tiempo', 'err');
  } else if(is_correct){
    if(btn) btn.classList.add('pulse-ok');
    await createEntry(brand, true, txt);
    overlay('ok','¡Correcto!','Estás participando');
    show(cfg.screenOk); // pantalla de marca breve
  } else {
    if(btn) btn.classList.add('shake');
    toast('Respuesta incorrecta', 'err');
    overlay('err','Respuesta incorrecta','Sigue participando');
  }

  setTimeout(()=>{
    if(brand==='tanqueray'){ startQuestion('johnnie_walker'); }
    else { finishRound(); }
  }, 1200);
}

async function createEntry(brand, is_correct, answer){
  const nowAns = new Date();
  const entry={
    entry_id:uid('e'),
    round_id:round.round_id,
    participant_id:participant.participant_id,
    brand,
    qualified:is_correct,
    reason:is_correct?'correct':'',
    answer,
    correct:is_correct,
    responded_at: nowAns.toISOString(),  // UTC
    responded_at_cl: nowChile(nowAns)    // Chile
  };
  try{
    await put('entries', entry); await logEvent('entry_created', entry);
    entries[brand] = !!is_correct;
    round.entered_brands = Object.entries(entries).filter(([_,v])=>v).map(([k])=>k);
  }catch(e){ toast('No se pudo guardar la inscripción', 'err'); console.error(e); }
}

async function finishRound(){
  const nowEnd = new Date();
  round.finished_at = nowEnd.toISOString();      // UTC
  round.finished_at_cl = nowChile(nowEnd);       // Chile
  await put('rounds', round);
  await logEvent('round_finished', {round_id: round.round_id, entered_brands: round.entered_brands});

  // Badges en final (solo marcas correctas)
  $('#badgeTQ').classList.toggle('hidden', !entries.tanqueray);
  $('#badgeJW').classList.toggle('hidden', !entries.johnnie_walker);
  show('scrEnd');

  // Auto retorno a portada tras 7s
  setTimeout(()=> hardReset(), 7000);
}

function hardReset(){
  participant=null; round=null; entries={tanqueray:false, johnnie_walker:false};
  show('scrHome');
}

/* ---------- Panel admin (tap 5×) -------- */
let taps=0, tapTimer=null;
$('#staffTap').addEventListener('click', ()=>{
  taps++; clearTimeout(tapTimer); tapTimer=setTimeout(()=>{taps=0}, 800);
  if(taps>=5){ taps=0; $('#staffPanel').style.display='flex'; }
});
$('#btnCloseStaff').onclick = ()=> $('#staffPanel').style.display='none';
$('#btnHardReset').onclick = ()=> { $('#staffPanel').style.display='none'; hardReset(); };
$('#btnPickDir').onclick = pickDir;

// Exportaciones con encabezados en español y separador ";"
$('#btnExportParticipants').onclick = async ()=>{
  const rows = await all('participants');
  downloadCSV('participants.csv', toCSVLocalized(rows, PARTICIPANT_COLUMNS));
};
$('#btnExportRounds').onclick = async ()=>{
  const rows = await all('rounds');
  downloadCSV('rounds.csv', toCSVLocalized(rows, ROUNDS_COLUMNS));
};
$('#btnExportEntries').onclick = async ()=>{
  const rows = await all('entries');
  downloadCSV('entries.csv', toCSVLocalized(rows, ENTRIES_COLUMNS));
};
$('#btnExportEvents').onclick = async ()=>{
  const rows = await all('events');
  const text = rows.map(r=>JSON.stringify(r)).join('\n');
  const blob = new Blob([text], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='events.jsonl'; a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
